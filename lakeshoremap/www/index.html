<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>TDT</title>
  <link rel="stylesheet" type="text/css" href="css/jquery.mobile-1.4.5.min.css" />
  <link rel="stylesheet" href="css/leaflet.css" />
  <link rel="stylesheet" href="css/easybutton.css" />
  <link href='https://api.mapbox.com/mapbox.js/v2.2.3/mapbox.css' rel='stylesheet' />

  <script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
  <script src='https://api.mapbox.com/mapbox.js/v2.2.3/mapbox.js'></script>
  <script type="text/javascript" src="json/buildings.json"></script>
  <script type="text/javascript" src="js/index.js"></script>
  <script src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
  <!--  <script type="text/javascript" src="js/jquery-2.1.4.min.js"></script> -->
  <script type="text/javascript" src="js/jquery.mobile-1.4.5.min.js"></script>
  <link rel="stylesheet" href="css/main.css">
  <link href="css/jquery.bxslider.css" rel="stylesheet" />
  <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.3.0/css/font-awesome.min.css"/>
  <link rel="stylesheet" href="css/waves.min.css" />
  <link rel="stylesheet" href="css/nativedroid2.css" />
  <script src="js/easybutton.js"></script>
  <script src="js/nativedroid2.js"></script>
  <script src="js/nd2settings.js"></script>
  <script src="http://code.jquery.com/ui/1.11.4/jquery-ui.min.js"></script>
  <script src="js/jquery.bxslider.min.js"></script>
  



<script type='text/javascript'>


      // function getLocation2() {
      //   navigator.geolocation.getCurrentPosition(onSuccess2,
      //     onFail2, {
      //     timeout: 15000,
      //     enableHighAccuracy: true
      //   });
      // }


  // var mapWidth = 1420,
  //   mapHeight = 2048;
  var markersOpacity = 1;
  var mapWidth = 1350;
  var mapHeight = 2144;
  // 999 indica q nenhum popup teve que ser aberto
  var currentBuildingId = 999;
  var myPosition=[0,0];
  var markerMyPosition;
  var markers = [];
  var map;
  var favBuildingFlag = false;
  // var x1_pixel = 202,
  //     y1_pixel = 203,
  //     x2_pixel = 1027,
  //     y2_pixel = 2007,
  //     x1_leaf = 81,
  //     y1_leaf = -144,
  //     x2_leaf = -82,
  //     y2_leaf = 2;
  // var x1_pixel = 300,
  //     y1_pixel = 1700,
  //     x2_pixel = 1024,
  //     y2_pixel = 1077,
  //     x1_leaf = -139.61432506887053,
  //     y1_leaf = 90.98807495741056,
  //     x2_leaf = 0,
  //     y2_leaf = 0,
  //     alphaLat = 70,
  //     alphaLong = 70;  
    // var x1_pixel = 661,
    //   y1_pixel = 1664,
    //   x2_pixel = 1024,
    //   y2_pixel = 1077,
    //   x1_leaf = -70,
    //   y1_leaf = -70,
    //   x2_leaf = 0,
    //   y2_leaf = 0;  



    var x1_pixel = 165,
      y1_pixel = 2003,
      x2_pixel = 1208,
      y2_pixel = 123,
      lat1_leaf = -250,
      long1_leaf = 20,
      lat2_leaf = -15,
      long2_leaf = 150;  


  function pixel2leaflet(x,y){


    var alpha_x = (long2_leaf-long1_leaf)/(x2_pixel-x1_pixel);
    var alpha_y = (lat2_leaf-lat1_leaf)/(y2_pixel-y1_pixel);
    return [(alpha_y*(y-y1_pixel)+lat1_leaf),(alpha_x*(x-x1_pixel)+long1_leaf)]

  }
  function coord2leaflet(x,y){
    var lat1_google = 41.994599,
        long1_google = -87.660353,
        lat2_google = 42.001569,
        long2_google = -87.658586,
        lat1_leaf2 = -251,
        long1_leaf2 = 28,
        lat2_leaf2 = -55,
        long2_leaf2 = 68;

    var alpha_long_google = (long2_leaf2-long1_leaf2)/(long2_google-long1_google);
    var alpha_lat_google = (lat2_leaf2-lat1_leaf2)/(lat2_google-lat1_google);


    return [(alpha_lat_google*(x-lat1_google)+lat1_leaf2 ),(alpha_long_google*(y-long1_google)+long1_leaf2 )]
  }

</script>
  <script src="js/init.js"></script> 
  <script src="js/jqm.leaflet.js"></script>
  <style>

  html, body, #homePage {
    height: 100%;
    margin: 0px;
    padding: 0px
  }

    .map{
      width:330px;
      height:500px;
      margin:0 auto;
    }

  </style>
</head>
<body>
<div data-role="page" id="homePage">

     <div class="headerMenu">
     <nd2-include data-src="panel.left.html"></nd2-include>
      <div data-role="header">
        <a href="#pageListBuilding2" class="ui-btn ui-btn-right"><i class="fa fa-search"></i></a>
        <a href="#leftpanel" onClick = "hideMyPosition()" class="ui-btn ui-btn-left"><i class="fa fa-bars"></i></a>
        <!-- <a href="#pageListBuilding" class="ui-btn ui-btn-right"><i class="fa fa-search"></i></a> -->
        <h1 class="wow fadeIn" data-wow-delay='0.4s'>Loyola Map</h1>
        <!-- <a href="#" class="ui-btn ui-btn-rigt wow fadeIn" data-wow-delay='1.2s'><i class="zmdi"></i></a> -->
      </div>
    </div>


  <div data-role="content" class="map"  id="map1_1" >
  </div><!-- /content -->

  <div data-role="panel" data-display="overlay" id="bars" >
    <ul data-role="listview">
        <li> <a href = "#pageListBuilding">List of Buildings</a></li>
        <li> <a  id = "getLocation" >Where am I?</a></li>
    </ul>
      
  </div><!-- /panel -->


</div>

<div data-role="page" id="pageListBuilding">
      <div data-role="header">
        <a data-rel="back" class="ui-btn ui-btn-left"><i class="fa fa-arrow-left"></i></a>
        <h1 class="wow fadeIn" data-wow-delay='0.4s'>Loyola Map</h1>
      </div>
  <div role="main" class="content" id = "listBuilding">
<!--     <div id = "listBuilding">
    </div>
     -->
  </div><!-- /content -->
  <div data-role="footer" data-position="fixed"> 
  </div><!-- /footer -->
</div><!-- /page2 -->

<div data-role="page" id="pageListBuilding2">
      <div data-role="header">
        <a data-rel="back" class="ui-btn ui-btn-left"><i class="fa fa-arrow-left"></i></a>
        <h1 class="wow fadeIn" data-wow-delay='0.4s'>Loyola Map</h1>
      </div>
  <div role="main" class="content" id = "listBuilding2">
<!--     <div id = "listBuilding">
    </div>
     -->
  </div><!-- /content -->
  <div data-role="footer" data-position="fixed"> 
  </div><!-- /footer -->
</div><!-- /page2 -->

<div data-role="page" id="pageFavAllBuildings">
      <div data-role="header">
        <!-- <a data-rel="back" class="ui-btn ui-btn-left"><i class="fa fa-arrow-left"></i></a> -->
        <a href = "#pageFavBuildings" onClick = "renderFavPage()" class="ui-btn ui-btn-left"><i class="fa fa-arrow-left"></i></a>
        <h1 class="wow fadeIn" data-wow-delay='0.4s'>Loyola Map</h1>
      </div>
  <div role="main" class="content" id = "listAllFavBuilding">
<!--     <div id = "listBuilding">
    </div>
     -->
  </div><!-- /content -->
  <div data-role="footer" data-position="fixed"> 
  </div><!-- /footer -->
</div>



<!-- <iframe src="pageFavBuildings.html"></iframe> -->

<div data-role="page" id="pageFavBuildings">
      <div data-role="header">
        <a href = "#homePage" class="ui-btn ui-btn-left"><i class="fa fa-arrow-left"></i></a>
        <a href = "#pageFavAllBuildings" class="ui-btn ui-btn-right"><i class="fa fa-plus"></i></a>
        <h1 class="wow fadeIn" data-wow-delay='0.4s'>Loyola Map</h1>
      </div>
  <div role="main" class="content" id = "listFavBuilding">
    <ul id='listViewFavBuilding' data-role= 'listview'>
    </u1>

  </div>
  <div data-role="footer" data-position="fixed"> 
    <div data-role="navbar">
    <ul>
      <li><a  href="#" data-role="button" data-icon="delete" data-iconpos="right" onClick = "deleteAllFavBuilding()">Delete All</a></li>
    </ul>
  </div>

  </div>
</div>



      <script type='text/javascript'>




      function createListBuilding(buildingsJson,opCode) {

        switch(opCode) {
          case 1:
            var ordenationAux = sortListFunction(buildingsJson);
            var result = "";
            result += "<ul id='searchBar' data-role= 'listview' data-filter='true' data-filter-placeholder='Search buildings...'> ";
            for(var i=0; i<buildingsJson.length; i++) {
              // result += "<li><a onClick = 'renderBuildingPage("+i+")'>"+ buildingsJson[i].name;
              result += "<li><a onClick = 'renderBuildingPage("+ordenationAux[i][1]+")'>"+ ordenationAux[i][0];
              result += "</a></li>";
            }
            result +="</ul>";
            break;
          case 2:
            var ordenationAux = sortListFunction(buildingsJson);
            var result = "";
            result += "<ul id='searchBar2' data-role= 'listview' data-filter='true' data-filter-placeholder='Search buildings...'> ";
            for(var i=0; i<buildingsJson.length; i++) {
              // result += "<li><a onClick = 'renderBuildingPage("+i+")'>"+ buildingsJson[i].name;
              result += "<li><a href = '#pageFavBuildings' onClick = 'saveBuilding("+ordenationAux[i][1]+")'>"+ ordenationAux[i][0];
              result += "</a></li>";
            }
            result +="</ul>";
            break;
          case 3:

            var result = "";
            // result += "<ul id='listViewFavBuilding' data-role= 'listview'> ";
            for(var i=0; i<buildingsJson.length; i++) {

              result += "<li><a onClick = 'renderBuildingPage("+buildingsJson[i][0]+")'>"+ buildingsJson[i][1];
              result += "</a></li>";




            }

            break;
            case 4:
            var ordenationAux = sortListFunction(buildingsJson);
            var result = "";
            result += "<ul id='searchBar' data-role= 'listview' data-filter='true' data-filter-placeholder='Search buildings...'> ";
            for(var i=0; i<buildingsJson.length; i++) {
              // result += "<li><a onClick = 'renderBuildingPage("+i+")'>"+ buildingsJson[i].name;
              result += "<li><a  href = '#homePage' onClick = 'setCurrentBuilding("+ordenationAux[i][1]+")'>"+ ordenationAux[i][0];
              result += "</a></li>";
            }
            result +="</ul>";
            break;

          default:
            break;
        }



        return result;
      }





    var total = createListBuilding(buildings.building,1);
    document.getElementById('listBuilding').innerHTML = total;
    var total2 = createListBuilding(buildings.building,2);
    document.getElementById('listAllFavBuilding').innerHTML = total2;
    var total4 = createListBuilding(buildings.building,4);
    document.getElementById('listBuilding2').innerHTML = total4;



    function showBuilding(){
      hideMyPosition();
      window.location="#homePage";
    }

    function renderBuildingPage(buildingId){
      hideMyPosition();
      currentBuildingId = buildingId;
      $(":mobile-pagecontainer").pagecontainer("change", "buildings.html", {
        changeHash: true
      });
    }
    $(document).on("pageshow", "#buildings", function( event ) {
      var slider = $('.bxslider').bxSlider({
          autoControls: true
      });
      var fillss = "";

      $("#buildingName").html(buildings.building[currentBuildingId].name);
      $("#bximages").html("");

      for (j in buildings.building[currentBuildingId].img){
        $("#bximages").append("<li><img src="+ buildings.building[currentBuildingId].img[j].url + "></li>");
      }

      slider.reloadSlider();
      $("#buildingDescription").html(buildings.building[currentBuildingId].description);
      $("#deleteFavoriteBuilding").html(fillss);



    });




    function hideMyPosition(){
      myPosition=[0,0];
      markerMyPosition.setOpacity(0);
    }
    function setCurrentBuilding(id_building){
      currentBuildingId = id_building;
    }
    function resetCurrentBuilding(){
      currentBuildingId = 999;
    }


    function sortFunction(a, b) {
      if (a[0] === b[0]) {
        return 0;
      }
      else {
        return (a[0] < b[0]) ? -1 : 1;
      }
    }

    function sortListFunction(buildingsJson){
      var ordenationAux = [];
        for(var i=0; i<buildingsJson.length; i++) {
          ordenationAux.push([buildingsJson[i].name, buildingsJson[i].id])
        }
        return ordenationAux.sort(sortFunction);
    }

    function saveBuilding(id) {
      if (id != null) {
        window.localStorage.setItem(id, buildings.building[id].name);
      }
      renderFavPage();


    }

    function getAllSavedBuildings() {
      if (window.localStorage.length == 0) {
        return 0;
      }
      var result = [];
      for(var i=0; i<window.localStorage.length; i++) {
          result.push(window.localStorage.key(i))
      }
      return result;
    }



    function renderFavPage(){
      favBuildingFlag = true;

      var favBuildings = getAllSavedBuildings();
      if(favBuildings == 0){
        $("#listViewFavBuilding").html("No building added...");
      } else{
        var aux = [];

        for(var key in localStorage) {
          aux.push([key , localStorage.getItem(key)]);
        }


        var result = createListBuilding(aux,3);

        $("#listViewFavBuilding").html(result);
        $("#listViewFavBuilding").listview().listview('refresh');

        
      }

    }



    function deleteAllFavBuilding(){
      localStorage.clear();
      renderFavPage();
    }
    function toggleMarkers(){
      if(markersOpacity == 0){
        markersOpacity = 1;
      }else{
        markersOpacity = 0;
      }
      for (var i = 1; i < markers.length; i++) {
        markers[i].setOpacity(markersOpacity);
      }
    }





      </script>
  <script type="text/javascript" src="cordova.js"></script>
  <script type="text/javascript" src="js/plugin.js"></script>
</body>
</html>
